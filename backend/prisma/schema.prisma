generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

model Utilisateur {
  id             String           @id @default(uuid())
  email          String           @unique
  motDePasse     String
  nom            String?
  prenom         String?
  role           Role             @default(TRADUCTEUR)
  actif          Boolean          @default(true)
  creeLe         DateTime         @default(now())
  modifieLe      DateTime         @updatedAt
  isPlayground   Boolean          @default(false)
  playgroundNote String?
  divisionAccess DivisionAccess[]
  traducteur     Traducteur?

  @@map("utilisateurs")
}

model Division {
  id          String           @id @default(uuid())
  nom         String           @unique
  code        String           @unique
  description String?
  actif       Boolean          @default(true)
  creeLe      DateTime         @default(now())
  modifieLe   DateTime         @updatedAt
  acces       DivisionAccess[]

  @@map("divisions")
}

model DivisionAccess {
  id            String      @id @default(uuid())
  utilisateurId String
  divisionId    String
  peutLire      Boolean     @default(true)
  peutEcrire    Boolean     @default(false)
  peutGerer     Boolean     @default(false)
  creeLe        DateTime    @default(now())
  modifieLe     DateTime    @updatedAt
  division      Division    @relation(fields: [divisionId], references: [id], onDelete: Cascade)
  utilisateur   Utilisateur @relation(fields: [utilisateurId], references: [id], onDelete: Cascade)

  @@unique([utilisateurId, divisionId])
  @@index([utilisateurId])
  @@index([divisionId])
  @@map("division_access")
}

model Traducteur {
  id                       String               @id @default(uuid())
  nom                      String
  domaines                 String[]
  clientsHabituels         String[]
  capaciteHeuresParJour    Float                @default(7.5)
  actif                    Boolean              @default(true)
  utilisateurId            String               @unique
  creeLe                   DateTime             @default(now())
  modifieLe                DateTime             @updatedAt
  classification           String
  horaire                  String?
  heureDinerDebut          String?              @default("12:00")
  heureDinerFin            String?              @default("13:00")
  notes                    String?
  specialisations          String[]             @default([])
  disponiblePourTravail    Boolean              @default(false)
  commentaireDisponibilite String?
  // Ciblage de la recherche de travail
  ciblageDisponibilite     Json?                // { divisions: [], categories: [], domaines: [], specialisations: [], equipeProjetId: null }
  categorie                CategorieTraducteur  @default(TR01)
  necessiteRevision        Boolean              @default(true)
  divisions                String[]             @default([])
  ajustementsTemps         AjustementTemps[]
  equipesProjet            EquipeProjetMembre[]
  interetsDemandes         InteretDemande[]
  reviseursDe              LiaisonReviseur[]    @relation("TraducteurReviseur")
  revisePar                LiaisonReviseur[]    @relation("TraducteurRevise")
  pairesLinguistiques      PaireLinguistique[]
  taches                   Tache[]
  utilisateur              Utilisateur          @relation(fields: [utilisateurId], references: [id], onDelete: Cascade)

  @@index([actif])
  @@index([disponiblePourTravail])
  @@index([categorie])
  @@map("traducteurs")
}

model PaireLinguistique {
  id           String     @id @default(uuid())
  langueSource String
  langueCible  String
  traducteurId String
  creeLe       DateTime   @default(now())
  traducteur   Traducteur @relation(fields: [traducteurId], references: [id], onDelete: Cascade)
  taches       Tache[]

  @@unique([traducteurId, langueSource, langueCible])
  @@index([langueSource, langueCible])
  @@map("paires_linguistiques")
}

model Client {
  id           String   @id @default(uuid())
  nom          String   @unique
  sousDomaines String[]
  actif        Boolean  @default(true)
  creeLe       DateTime @default(now())
  modifieLe    DateTime @updatedAt
  taches       Tache[]

  @@map("clients")
}

model SousDomaine {
  id            String   @id @default(uuid())
  nom           String   @unique
  domaineParent String?
  actif         Boolean  @default(true)
  creeLe        DateTime @default(now())
  modifieLe     DateTime @updatedAt
  taches        Tache[]

  @@map("sous_domaines")
}

model Tache {
  id                        String             @id @default(uuid())
  numeroProjet              String             @default("N/A")
  description               String             @default("")
  specialisation            String             @default("")
  heuresTotal               Float
  compteMots                Int?
  dateEcheance              DateTime
  priorite                  String             @default("REGULIER")
  statut                    StatutTache        @default(PLANIFIEE)
  typeTache                 TypeTache          @default(TRADUCTION)
  modeDistribution          ModeDistribution   @default(JAT)
  traducteurId              String
  clientId                  String?
  sousDomaineId             String?
  paireLinguistiqueId       String?
  creePar                   String
  creeLe                    DateTime           @default(now())
  modifieLe                 DateTime           @updatedAt
  version                   Int                @default(0)
  modifiePar                String?
  commentaireCloture        String?
  dateDebutEffective        DateTime?
  dateFinEffective          DateTime?
  notificationRetardEnvoyee Boolean            @default(false)
  ajustementsTemps          AjustementTemps[]
  historique                HistoriqueTache[]
  notifications             Notification[]
  client                    Client?            @relation(fields: [clientId], references: [id])
  paireLinguistique         PaireLinguistique? @relation(fields: [paireLinguistiqueId], references: [id])
  sousDomaine               SousDomaine?       @relation(fields: [sousDomaineId], references: [id])
  traducteur                Traducteur         @relation(fields: [traducteurId], references: [id], onDelete: Cascade)

  @@index([traducteurId])
  @@index([dateEcheance])
  @@index([statut])
  @@index([priorite])
  @@map("taches")
}

model HistoriqueTache {
  id             String   @id @default(uuid())
  tacheId        String
  action         String
  champModifie   String?
  ancienneValeur String?
  nouvelleValeur String?
  utilisateurId  String
  utilisateur    String
  details        String?
  creeLe         DateTime @default(now())
  tache          Tache    @relation(fields: [tacheId], references: [id], onDelete: Cascade)

  @@index([tacheId])
  @@index([creeLe])
  @@map("historique_taches")
}

model Notification {
  id             String           @id @default(uuid())
  type           TypeNotification
  titre          String
  message        String
  lue            Boolean          @default(false)
  destinataireId String
  tacheId        String?
  donnees        String?
  creeLe         DateTime         @default(now())
  lueLe          DateTime?
  tache          Tache?           @relation(fields: [tacheId], references: [id], onDelete: Cascade)

  @@index([destinataireId, lue])
  @@index([destinataireId, creeLe])
  @@index([tacheId])
  @@map("notifications")
}

model AjustementTemps {
  id           String         @id @default(uuid())
  type         TypeAjustement
  traducteurId String
  tacheId      String?
  creePar      String
  creeLe       DateTime       @default(now())
  date         DateTime       @db.Date
  heures       Float
  heureDebut   String?
  heureFin     String?
  tache        Tache?         @relation(fields: [tacheId], references: [id], onDelete: Cascade)
  traducteur   Traducteur     @relation(fields: [traducteurId], references: [id], onDelete: Cascade)

  @@unique([traducteurId, date, tacheId, type])
  @@index([traducteurId, date])
  @@map("ajustements_temps")
}

model LiaisonReviseur {
  id           String      @id @default(uuid())
  traducteurId String
  reviseurId   String
  estPrincipal Boolean     @default(true)
  actif        Boolean     @default(true)
  notes        String?
  creeLe       DateTime    @default(now())
  modifieLe    DateTime    @updatedAt
  dateFin      DateTime?
  domaine      String?
  mode         ModeLiaison @default(ATTITRE)
  reviseur     Traducteur  @relation("TraducteurReviseur", fields: [reviseurId], references: [id], onDelete: Cascade)
  traducteur   Traducteur  @relation("TraducteurRevise", fields: [traducteurId], references: [id], onDelete: Cascade)

  @@unique([traducteurId, reviseurId])
  @@index([traducteurId])
  @@index([reviseurId])
  @@index([estPrincipal])
  @@map("liaisons_reviseur")
}

model DemandeRessource {
  id               String           @id @default(uuid())
  conseillerId     String
  titre            String
  description      String?
  heuresEstimees   Float?
  langueSource     String?
  langueCible      String?
  division         String?          // DEPRECATED - utiliser divisions[]
  divisions        String[]         @default([])  // Filtrer par divisions
  categories       String[]         @default([])  // TR01, TR02, TR03
  specialisations  String[]         @default([])  // Spécialités recherchées
  domaines         String[]         @default([])  // Domaines de compétence
  equipeProjetId   String?                        // Équipe-projet spécifique
  urgence          Urgence          @default(NORMALE)
  actif            Boolean          @default(true)
  creeLe           DateTime         @default(now())
  modifieLe        DateTime         @updatedAt
  expireLe         DateTime?
  interets         InteretDemande[]

  @@index([conseillerId])
  @@index([actif])
  @@index([urgence])
  @@map("demandes_ressources")
}

// Manifestation d'intérêt d'un traducteur pour une demande de ressource
model InteretDemande {
  id           String          @id @default(uuid())
  demandeId    String
  traducteurId String
  message      String?         // Message optionnel du traducteur
  creeLe       DateTime        @default(now())
  demande      DemandeRessource @relation(fields: [demandeId], references: [id], onDelete: Cascade)
  traducteur   Traducteur      @relation(fields: [traducteurId], references: [id], onDelete: Cascade)

  @@unique([demandeId, traducteurId])
  @@index([demandeId])
  @@index([traducteurId])
  @@map("interets_demandes")
}

model EquipeProjet {
  id          String               @id @default(uuid())
  nom         String               @unique
  code        String               @unique
  description String?
  couleur     String               @default("#3B82F6")
  clientId    String?
  clientNom   String?
  objectif    String?
  dateDebut   DateTime?
  dateFin     DateTime?
  actif       Boolean              @default(true)
  archive     Boolean              @default(false)
  creePar     String
  creeLe      DateTime             @default(now())
  modifiePar  String?
  modifieLe   DateTime             @updatedAt
  membres     EquipeProjetMembre[]

  @@index([actif])
  @@index([archive])
  @@index([clientId])
  @@map("equipes_projet")
}

model EquipeProjetMembre {
  id             String       @id @default(uuid())
  equipeProjetId String
  traducteurId   String
  role           RoleEquipe   @default(MEMBRE)
  dateAjout      DateTime     @default(now())
  dateRetrait    DateTime?
  actif          Boolean      @default(true)
  ajoutePar      String
  notes          String?
  equipeProjet   EquipeProjet @relation(fields: [equipeProjetId], references: [id], onDelete: Cascade)
  traducteur     Traducteur   @relation(fields: [traducteurId], references: [id], onDelete: Cascade)

  @@unique([equipeProjetId, traducteurId])
  @@index([equipeProjetId])
  @@index([traducteurId])
  @@index([actif])
  @@map("equipes_projet_membres")
}

enum TypeNotification {
  TACHE_EN_COURS
  TACHE_EN_RETARD
  TACHE_TERMINEE
  ESCALADE_GESTIONNAIRE
  RAPPEL_FERMETURE
}

enum Role {
  ADMIN
  CONSEILLER
  GESTIONNAIRE
  TRADUCTEUR
}

enum StatutTache {
  PLANIFIEE
  EN_COURS
  TERMINEE
  EN_RETARD
}

enum TypeTache {
  TRADUCTION
  REVISION
  RELECTURE
  ENCADREMENT
  AUTRE
}

enum TypeAjustement {
  TACHE
  BLOCAGE
}

enum ModeDistribution {
  JAT
  PEPS
  EQUILIBRE
  MANUEL
}

enum CategorieTraducteur {
  TR01
  TR02
  TR03
}

enum ModeLiaison {
  ATTITRE
  PONCTUEL
}

enum Urgence {
  FAIBLE
  NORMALE
  HAUTE
  CRITIQUE
}

enum RoleEquipe {
  RESPONSABLE
  MEMBRE
  REVISEUR
}
